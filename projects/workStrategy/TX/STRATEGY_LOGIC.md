# TX Trading Strategy Logic (Final Version)

> 本文件描述目前 `analyzer.py` 實作的交易邏輯。這是一個結合「宏觀風險濾網」與「技術動能」的混合策略。

---

## 策略總覽 (Strategy Overview)

本策略的核心思想是：**「平時順勢持有，遇到宏觀風險避險，但在安全區間內敢於追價」**。

- **夜盤 (Night)**: 預設 **Buy & Hold**，除非遇到宏觀風險或長假。
- **日盤 (Day)**: 預設 **Momentum** (動能策略)，沒行情就休息，有行情才做。

---

## 1. 使用因子 (Factors)

| 因子代號 | 名稱 | 定義 | 作用 |
| :--- | :--- | :--- | :--- |
| **`yield_shock`** | 估值衝擊 | 美債5年殖利率 - 20日前數值 | **核心風控**。數值飆高代表債市崩跌、資金成本急升，股市通常會跟跌。 |
| **`holiday`** | 長假天數 | 距離上次交易日的天數 | **避險**。數值 > 2 (如週五或連假前) 代表有長假風險。 |
| **`divergence`** | 技術乖離 | (收盤價 / 15日均線) - 1 | **核心進出訊號**。衡量目前價格相對於趨勢的強弱。 |

> *註: Yield Volatility (波動率) 因子已移除，目前不參與風控。*

---

## 2. 交易邏輯 (Trading Logic)

程式碼執行順序如下 (後者覆蓋前者)：

### Step 1: 初始設定 (Initialization)
- **夜盤**: `1.0` (持有)
- **日盤**: `1.0` (持有)

### Step 2: 宏觀與日曆風控 (Macro & Calendar Filter)
此階段為「減法」，強制將部位歸零。

1.  **估值衝擊 (Yield Shock)**:
    -   條件: `yield_shock > 0.15`
    -   動作: **日夜盤全平 (Flat All)**。
    -   *意義*: 債市崩跌時，避開與大盤同歸於盡的風險。

2.  **長假避險 (Holiday Risk)**:
    -   條件: `holiday > 2`
    -   動作: **日夜盤全平 (Flat All)**。
    -   *意義*: 不抱單過週末或連假，規避跳空風險。

### Step 3: 技術面微調與進場 (Technical Override)
此階段為「加法」與「過濾」，根據動能強度決定最終部位。

**前提條件**: 宏觀風險未達極致 (`yield_shock <= 0.3`)。
> 若 `yield_shock > 0.3` (極度危險)，此階段直接跳過，維持 Step 2 的空手狀態。

1.  **夜盤恢復持有 (Night Re-Entry)**:
    -   條件: `divergence > 0.0035`
    -   動作: **Night = 1.0**
    -   *意義*: 即使 Layer 2 (Shock > 0.15) 叫你避險，只要 Shock 沒爆掉 (< 0.3) 且趨勢向上 (> 0.0035)，夜盤選擇**在安全的地方勇敢做多**。

2.  **日盤順勢進場 (Day Momentum)**:
    -   條件: `divergence > 0.0045`
    -   動作: **Day = 1.0**
    -   *意義*: 日盤的進場門檻較高，確認主升段才進場。

3.  **日盤動能消失 (Day Exit)**:
    -   條件: `divergence < 0.0045`
    -   動作: **Day = 0.0**
    -   *意義*: **這是日盤最重要的規則**。由 Step 1 初始化的 1.0 其實是假的，只要動能不足 (< 0.45%)，日盤一律空手。這確保日盤只吃「魚身」，不吃盤整和魚尾。

---

## 3. 總結 (Summary)

- **夜盤**: 基本上是用 **Yield Shock > 0.15** 和 **Holiday** 來避險。但保留了一條「安全區間 (Shock < 0.3) + 趨勢向上」的後門，允許在風險可控時繼續持有。
- **日盤**: 嚴格的 **Momentum** 策略。只有在 `divergence > 0.0045` 且 `Shock <= 0.3` 時才會持有，其餘時間皆為空手 (Cash)。
